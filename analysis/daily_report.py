# üìä G√ºnl√ºk Rapor Sistemi

import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime, timedelta
import os

# Local imports
from analysis.productivity_score import hesapla_urekenlik_puani
from ai.gemini import al_gemini_onerisi
from utils.pdf_generator import gunluk_rapor_pdf
from config.config import ANALYSIS_FILE

def turkce_temizle(metin: str) -> str:
    """T√ºrk√ße karakterleri ASCII'ye kapsamlƒ± ≈üekilde √ßevirir"""
    if not metin:
        return ""
    
    # T√ºrk√ße karakter d√∂n√º≈ü√ºm tablosu (ASCII safe)
    donusum = {
        '√ß': 'c', '√á': 'C',
        'ƒü': 'g', 'ƒû': 'G', 
        'ƒ±': 'i', 'I': 'I',
        '√∂': 'o', '√ñ': 'O',
        '≈ü': 's', '≈û': 'S',
        '√º': 'u', '√ú': 'U'
    }
    
    # Karakterleri deƒüi≈ütir
    for tr_char, en_char in donusum.items():
        metin = metin.replace(tr_char, en_char)
    
    # ASCII olmayan karakterleri kaldƒ±r
    try:
        metin = metin.encode('ascii', 'ignore').decode('ascii')
    except:
        pass
    
    return metin

def veri_yukle() -> pd.DataFrame:
    """Analiz verilerini y√ºkler"""
    try:
        # ANALYSIS_FILE zaten full path i√ßeriyor (config'ten)
        dosya_yolu = ANALYSIS_FILE
        if os.path.exists(dosya_yolu):
            df = pd.read_excel(dosya_yolu)
            df['Zaman'] = pd.to_datetime(df['Zaman'])
            return df
        else:
            print(f"‚ö†Ô∏è Analiz dosyasƒ± bulunamadƒ±: {dosya_yolu}")
            return pd.DataFrame()
    except Exception as e:
        print(f"‚ùå Veri y√ºkleme hatasƒ±: {e}")
        return pd.DataFrame()

def gunluk_veri_filtrele(df: pd.DataFrame, tarih: str = None) -> pd.DataFrame:
    """Belirli bir g√ºne ait verileri filtreler"""
    if tarih is None:
        tarih = datetime.now().strftime('%Y-%m-%d')
    
    # Tarihi datetime'a √ßevir
    hedef_tarih = pd.to_datetime(tarih).date()
    
    # O g√ºne ait verileri filtrele
    gunluk_df = df[df['Zaman'].dt.date == hedef_tarih]
    return gunluk_df

def gunluk_dashboard_grafik(df: pd.DataFrame, dosya_adi: str, tarih: str) -> str:
    """4-panel g√ºnl√ºk dashboard olu≈üturur (saat cinsinden, y√ºksek kalite)"""
    try:
        if df.empty:
            return None
        
        # S√ºreleri saat cinsinden hesapla
        df_saat = df.copy()
        df_saat['S√ºre (saat)'] = df_saat['S√ºre (dk)'] / 60
        
        # üé® GENEL FONT AYARLARI
        plt.rcParams.update({
            "font.size": 12,
            "axes.titlesize": 18,
            "axes.labelsize": 14,
            "xtick.labelsize": 12,
            "ytick.labelsize": 12,
            "font.weight": "bold"
        })
        
        # Figure ve 4 panel (y√ºksek kalite) - ba≈ülƒ±k kaldƒ±rƒ±ldƒ±
        fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(16, 11))
        fig.patch.set_facecolor('#f8f9fa')  # A√ßƒ±k gri arka plan
        
        # 1. Kategori Daƒüƒ±lƒ±mƒ± (Pasta) - Saat cinsinden
        kategori_sure = df_saat.groupby('Kategori')['S√ºre (saat)'].sum()
        if not kategori_sure.empty:
            # Kategori isimlerini temizle
            kategori_ascii = {}
            for kategori, sure in kategori_sure.items():
                kategori_clean = turkce_temizle(kategori)
                kategori_ascii[kategori_clean] = sure
            
            # Modern renkler
            colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e']
            wedges, texts, autotexts = ax1.pie(kategori_ascii.values(), labels=kategori_ascii.keys(), 
                   autopct='%1.1f%%', colors=colors[:len(kategori_ascii)], startangle=90,
                   textprops={'fontsize': 13, 'fontweight': 'bold'},
                   wedgeprops={'linewidth': 3, 'edgecolor': 'white'})
            ax1.set_title('KATEGORI DAGILIMI', fontsize=18, fontweight='bold', color='#2c3e50', pad=25)
            
            # Pasta grafiƒüi yazƒ±larƒ± daha b√ºy√ºk ve belirgin
            for autotext in autotexts:
                autotext.set_color('white')
                autotext.set_fontsize(12)
                autotext.set_fontweight('bold')
        
        # 2. Saatlik Trend - Saat cinsinden
        df_copy = df_saat.copy()
        df_copy['Saat'] = df_copy['Zaman'].dt.hour
        saatlik = df_copy.groupby('Saat')['S√ºre (saat)'].sum()
        
        if not saatlik.empty:
            # Gradyan renkler
            bar_colors = ['#2980b9' if v > 0.7 else '#3498db' if v > 0.3 else '#74b9ff' for v in saatlik.values]
            bars = ax2.bar(saatlik.index, saatlik.values, color=bar_colors, alpha=0.9, width=0.6,
                          edgecolor='#1e3799', linewidth=2)
            
            ax2.set_title('SAATLIK AKTIVITE', fontsize=18, fontweight='bold', color='#2c3e50', pad=25)
            ax2.set_xlabel('Saat', fontsize=14, fontweight='bold')
            ax2.set_ylabel('Sure (saat)', fontsize=14, fontweight='bold')
            ax2.grid(True, alpha=0.4, color='#bdc3c7', linewidth=1)
            ax2.set_xlim(7, 19)  # √áalƒ±≈üma saatleri
            ax2.set_facecolor('#ecf0f1')
            
            # Bar deƒüerleri (saat cinsinden)
            for i, v in enumerate(saatlik.values):
                if v > 0:
                    ax2.text(saatlik.index[i], v + 0.05, f'{v:.1f}h', ha='center', va='bottom', 
                            fontweight='bold', fontsize=12, color='#2c3e50')
        
        # 3. Aktivite Sƒ±klƒ±ƒüƒ± - Temiz kategoriler
        aktivite_sayisi = df.groupby('Kategori').size()
        if not aktivite_sayisi.empty:
            # Kategori isimlerini temizle
            aktivite_ascii = {}
            for kategori, sayisi in aktivite_sayisi.items():
                kategori_clean = turkce_temizle(kategori)
                aktivite_ascii[kategori_clean] = sayisi
            
            # Profesyonel renkler
            bright_colors = ['#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'][:len(aktivite_ascii)]
            bars = ax3.bar(aktivite_ascii.keys(), aktivite_ascii.values(), 
                          color=bright_colors, alpha=0.9, edgecolor='white', linewidth=3)
            
            ax3.set_title('AKTIVITE SIKLIGI', fontsize=18, fontweight='bold', color='#2c3e50', pad=25)
            ax3.set_ylabel('Kayit Sayisi', fontsize=14, fontweight='bold')
            ax3.tick_params(axis='x', rotation=45, labelsize=12)
            ax3.set_facecolor('#ecf0f1')
            ax3.grid(True, alpha=0.4, color='#bdc3c7', axis='y', linewidth=1)
            
            # Bar deƒüerleri
            for bar in bars:
                height = bar.get_height()
                ax3.text(bar.get_x() + bar.get_width()/2., height + 0.15,
                        f'{int(height)}', ha='center', va='bottom', fontweight='bold', 
                        fontsize=13, color='#2c3e50')
        
        # 4. Verimlilik Analizi - Saat cinsinden
        verim_data = df_saat.groupby('Kategori').agg({
            'S√ºre (saat)': 'sum',
            'Kategori': 'count'
        }).rename(columns={'Kategori': 'Sayƒ±'})
        
        if not verim_data.empty:
            # Premium renkli noktalar
            scatter_colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'][:len(verim_data)]
            scatter = ax4.scatter(verim_data['Sayƒ±'], verim_data['S√ºre (saat)'], 
                                c=scatter_colors, s=400, alpha=0.8, 
                                edgecolors='white', linewidth=4)
            
            # Kategori adlarƒ± (temiz)
            for i, kategori in enumerate(verim_data.index):
                kategori_clean = turkce_temizle(kategori)
                ax4.annotate(kategori_clean, 
                           (verim_data.iloc[i]['Sayƒ±'], verim_data.iloc[i]['S√ºre (saat)']),
                           xytext=(10, 10), textcoords='offset points', 
                           fontsize=11, fontweight='bold', color='#2c3e50',
                           bbox=dict(boxstyle='round,pad=0.4', facecolor='white', alpha=0.9, edgecolor='gray'))
            
            ax4.set_title('VERIMLILIK HARITASI', fontsize=18, fontweight='bold', color='#2c3e50', pad=25)
            ax4.set_xlabel('Aktivite Sayisi', fontsize=14, fontweight='bold')
            ax4.set_ylabel('Toplam Sure (saat)', fontsize=14, fontweight='bold')
            ax4.grid(True, alpha=0.4, color='#bdc3c7', linewidth=1)
            ax4.set_facecolor('#ecf0f1')
        
        # Layout d√ºzenle (daha fazla bo≈üluk)
        plt.tight_layout()
        plt.subplots_adjust(hspace=0.55, wspace=0.35)
        
        # Kaydet (ultra y√ºksek kalite - 600 DPI)
        os.makedirs("temp", exist_ok=True)
        grafik_yolu = f"temp/{dosya_adi}"
        plt.savefig(grafik_yolu, dpi=600, bbox_inches='tight', facecolor='#f8f9fa', 
                   edgecolor='none', format='png')
        plt.close()
        
        print(f"‚úÖ Yuksek kalite grafik kaydedildi: {grafik_yolu}")
        return grafik_yolu
    except Exception as e:
        print(f"‚ùå Grafik olusturma hatasi: {e}")
        import traceback
        print(traceback.format_exc())
        return None

def kompakt_ozet_olustur(df: pd.DataFrame) -> str:
    """Kompakt √∂zet metin olu≈üturur (g√ºnl√ºk raporlar i√ßin)"""
    if df.empty:
        return "Bu d√∂nem i√ßin veri bulunamadƒ±."
    
    toplam_sure = df['S√ºre (dk)'].sum()
    kategori_sure = df.groupby('Kategori')['S√ºre (dk)'].sum()
    en_cok = kategori_sure.idxmax() if not kategori_sure.empty else "Yok"
    
    # Minimal √∂zet
    ozet = f"Toplam aktif s√ºre: {toplam_sure} dakika ({toplam_sure/60:.1f} saat)\n"
    ozet += f"Toplam kayƒ±t sayƒ±sƒ±: {len(df)}\n"
    
    # En √ßok zaman harcanan kategoriyi g√∂ster
    if not kategori_sure.empty:
        en_cok_sure = kategori_sure.max()
        ozet += f"En √ßok zaman: {en_cok} ({en_cok_sure} dk)\n"
        
        # Sadece en √∂nemli kategorileri g√∂ster
        for kategori, sure in kategori_sure.head(3).items():  # Sadece ilk 3
            yuzde = (sure / toplam_sure) * 100
            ozet += f"‚Ä¢ {kategori}: {sure} dk ({yuzde:.0f}%)\n"
    
    return ozet

def gunluk_rapor_olustur(tarih: str = None) -> str:
    """Modern g√∂rsel aƒüƒ±rlƒ±klƒ± g√ºnl√ºk rapor olu≈üturur"""
    import shutil
    print("üìä Modern g√ºnl√ºk rapor olu≈üturuluyor...")
    
    # Veri y√ºkle
    df = veri_yukle()
    if df.empty:
        return "‚ùå Veri bulunamadƒ±ƒüƒ± i√ßin rapor olu≈üturulamadƒ±."
    
    # G√ºnl√ºk veriyi filtrele
    if tarih is None:
        tarih = datetime.now().strftime('%Y-%m-%d')
    
    gunluk_df = gunluk_veri_filtrele(df, tarih)
    
    if gunluk_df.empty:
        return f"‚ùå {tarih} tarihine ait veri bulunamadƒ±."
    
    # √úretkenlik puanƒ± hesapla
    puan, yorumlar = hesapla_urekenlik_puani(gunluk_df)
    
    # Kompakt √∂zet olu≈ütur (daha az metin)
    ozet = kompakt_ozet_olustur(gunluk_df)
    
    # 4-panel modern dashboard grafik olu≈ütur
    grafik_yolu = gunluk_dashboard_grafik(gunluk_df, f"gunluk_dashboard_{tarih}.png", tarih)
    
    # Gemini √∂nerisi al (kƒ±sa tutmasƒ±nƒ± s√∂yle)
    kisa_prompt = f"G√ºnl√ºk √∂zet: {ozet}\nPuan: {puan}/10\n\nKƒ±sa ve motive edici √∂neride bulun (max 150 kelime)."
    gemini_cevap = al_gemini_onerisi(kisa_prompt, puan)
    
    # PDF olu≈ütur (yeni modern tasarƒ±m)
    pdf_yolu = gunluk_rapor_pdf(tarih, ozet, puan, gemini_cevap, grafik_yolu)
    
    # Ge√ßici dosyalarƒ± ve temp klas√∂r√ºn√º temizle
    if grafik_yolu and os.path.exists(grafik_yolu):
        os.remove(grafik_yolu)
    
    # Temp klas√∂r√ºn√º tamamen temizle
    try:
        shutil.rmtree("temp", ignore_errors=True)
        print("üßπ Ge√ßici dosyalar temizlendi")
    except:
        pass
    
    return f"‚úÖ Modern g√ºnl√ºk rapor: {pdf_yolu}\nüìä Puan: {puan}/10"

# Test fonksiyonu
if __name__ == "__main__":
    print("üîç G√ºnl√ºk Rapor Testi:")
    print(gunluk_rapor_olustur()) 